<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>WebGL</title>
  
  <!--<script src="glMatrix-0.9.5.min.js"></script>-->
  <script src="./gl-matrix-min.js"></script>
  
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0px;
      padding: 0px;
    }
    #canvasDiv {
        display: flex;
        width: 100%;
        height: 100%;
        align-items: center;
        justify-content: center;
    }
    canvas {
        width: 100%;
        height: 100%;
        margin: 0px;
    }
  </style>
  
</head>
<body onload="main()">

<div id="fpsDiv" style="position: absolute; top: 10px; left: 10px; color:white; background-color:blue;">
  <span id="fpsSpan">FPS</span>
</div>
<div id="fovSliderDiv" style="position: absolute; top: 50px; left: 10px;">
  <input id="fovSlider" type="range" min="10.0" max="90.0" value="45.0" class="slider" onchange="handleFovSlider(this.value)"/>
  <label for="fovSlider" id="fovLabel">FOV: 45.0</label>
</div>

<div id="pitchSliderDiv" style="position: absolute; top: 70px; left: 10px;">
  <input id="pitchSlider" type="range" min="-45.0" max="45.0" value="0.0" class="slider" onchange="handlePitchSlider(this.value)"/>
  <label for="pitchSlider" id="pitchLabel">Pitch: 0.0</label>
</div>
<div id="yawSliderDiv" style="position: absolute; top: 90px; left: 10px;">
  <input id="yawSlider" type="range" min="-45.0" max="45.0" value="0.0" class="slider" onchange="handleYawSlider(this.value)"/>
  <label for="yawSlider" id="yawLabel">Yaw: 0.0</label>
</div>
<div id="cameraInputActiveDiv" style="position: absolute; top: 110px; left: 10px;">
  <input id="cameraInputActive" type="checkbox" checked onchange="handleCameraInputActive(this.checked)"/>
  <label for="cameraInputActive" id="cameraInputLabel">FPS Camera Active</label>
</div>

<div id="canvasDiv">
<canvas id="myCanvas"></canvas>
</div>

<script src="./Debug.js"></script>
<script src="./Renderer.js"></script>
<script src="./LoopTimer.js"></script>
<script src="./Shader.js"></script>
<script src="./Mesh.js"></script>
<script src="./FPSCamera.js"></script>
<script>
// global vars
var render = null;
var timer = null;
var shader = null;
var testTriangleMesh = null;
var camera = null;
var cameraRotate = false;

function mainLoop() {

    shader.Use();
    
    camera.Update(timer.dt / 1000.0);
    shader.SetMatrixUniform(
        Shader.VIEW_MAT_UNIFORM,
        camera.viewMatrix
    );

    render.BeginFrame();
        render.DrawMesh(testTriangleMesh);
    render.EndFrame();

    timer.Update();

    window.requestAnimationFrame(mainLoop);
}

function main() {
    render = new Renderer("myCanvas");
    render.SetClearColor([0.0, 0.5, 0.5]);

    timer = new LoopTimer("fpsSpan");

    shader = new Shader(
        render.gl,
        document.getElementById("vertexShader").text,
        document.getElementById("fragmentShader").text
    );
    shader.Use();

    camera = new FPSCamera();
    //camera.Update(1.0/60.0);

    shader.SetMatrixUniform(
        Shader.PERSPECTIVE_MAT_UNIFORM,
        render.perspectiveMatrix
    );
    var identMat = mat4.create();
    mat4.identity( identMat );
    shader.SetMatrixUniform(
        Shader.MODEL_MAT_UNIFORM,
        identMat
    );

    testTriangleMesh = new Mesh(
        render.gl,
        [ -0.5, -0.5, 0.0,
            0.5, -0.5, 0.0,
            0.0, 0.5, 0.0
        ],
        3, // elements per vertex
        null
    );

    mainLoop();
}

function handleFovSlider(fovDegrees) {
    render.perspectiveMatrix = mat4.perspective(
        fovDegrees,
        render.canvas.width / render.canvas.height,
        1.0,
        1000.0
    );
    shader.SetMatrixUniform(
        Shader.PERSPECTIVE_MAT_UNIFORM,
        render.perspectiveMatrix
    );
    document.getElementById("fovLabel").innerHTML = "FOV: " + fovDegrees;
}
function handlePitchSlider(pitchDegrees) {
    var pitchRad = pitchDegrees * Math.PI / 180.0;
    camera.pitch = pitchRad;
    camera.Update(1.0/60.0);
    document.getElementById("pitchLabel").innerHTML = "Pitch: " + pitchDegrees;
}
function handleYawSlider(yawDegrees) {
    var yawRad = yawDegrees * Math.PI / 180.0;
    camera.yaw = yawRad;
    camera.Update(1.0/60.0);
    document.getElementById("yawLabel").innerHTML = "Yaw: " + yawDegrees;
}
function handleCameraInputActive(isChecked) {
    camera.keyboardInputActive = (isChecked) ? true : false;
    if (isChecked) {
        document.getElementById("cameraInputLabel").innerHTML = "FPS Camera Active";
    }
    else {
        document.getElementById("cameraInputLabel").innerHTML = "FPS Camera Inactive";
    }
}
</script>

<script id="vertexShader" type="x-shader/x-vertex">#version 300 es
layout(location = 0) in vec3 aPosition;
layout(location = 1) in vec3 aNormal;
layout(location = 2) in vec2 aTexCoord;

uniform mat4 uPerspectiveMatrix;
uniform mat4 uViewMatrix;
uniform mat4 uModelMatrix;

void main() {
    gl_Position = uPerspectiveMatrix *
                  uViewMatrix *
                  uModelMatrix *
                  vec4(aPosition, 1.0);
}
</script>

<script id="fragmentShader" type="x-shader/x-fragment">#version 300 es
precision mediump float;

out vec4 outColor;
void main() {
    outColor = vec4(1.0, 0.0, 0.0, 1.0);
}
</script>

</body>
</html>

